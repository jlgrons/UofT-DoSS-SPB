---
title: 'Solution 3: Graphing'
author: "Yaqi Shi"
date: "07/12/2024"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(skimr)
library(visdat)
library(janitor)
```

# NYC bus delays

The data is from the kaggle dataset "Bus Breakdown and Delays NYC - When and why a bus was delayed? Bus delays 2015 to 2017". (https://www.kaggle.com/anthobau/busbreakdownanddelays).

The Bus Breakdown and Delay system collects information from school bus vendors operating out in the field in real time. Bus staff that encounter delays during the route are instructed to radio the dispatcher at the bus vendorâ€™s central office. The bus vendor staff are then instructed to log into the Bus Breakdown and Delay system to record the event and notify OPT. OPT customer service agents use this system to inform parents who call with questions regarding bus service. The Bus Breakdown and Delay system is publicly accessible and contains real time updates. All information in the system is entered by school bus vendor staff.

You can find data for years 2015 to 2017.

```{r}
bus.delay <- read_csv("Bus_Breakdown_and_Delays.csv")
head(bus.delay)
```

The following code creates new features 

```{r}
library(lubridate)

bus.delay$occur_date <- as.POSIXct(bus.delay$Occurred_On, format= "%m/%d/%Y %H:%M:%S %p")

# Day of the week
bus.delay$occur_weekday <- wday(bus.delay$occur_date, label = T)
bus.delay$occur_month <- month(bus.delay$occur_date, label = T)
bus.delay$occur_year <- year(bus.delay$occur_date)
#head(bus.delay)
```

1. Group by `occur_month`, and generate a bar plot that showing the number of delays by month. 

```{r}
#library(ggplot2)
# tidyverse
bus.delay %>%
  group_by(occur_month) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = occur_month, y = count)) + #axis
  geom_bar(stat = 'identity') # stacked 
```

The following code generates a new variable called "duration" in mins. 

```{r}
bus.delay$duration <- as.numeric(gsub("([0-9]{1,2}).*$", "\\1", bus.delay$How_Long_Delayed))
```


2. Plot the boxplot of duration. 

```{r}
ggplot(data = bus.delay) + 
  geom_boxplot(aes(x = duration)) + theme_classic()
```

3. Plot a histogram of durations and group by "Boro".

```{r}
ggplot(data = bus.delay) + 
  geom_histogram(aes(x = duration, y = ..density.., fill = Boro), 
                 position = 'dodge', 
                 bins = 3)  
```

4. Plot the density of duration, group by "occur_weekday" and use facet to stratify on" "Boro".

```{r}
ggplot(data = bus.delay) + 
  geom_density(aes(x = duration, color = occur_weekday), bw = .08) + 
  facet_wrap(~Boro, ncol = 4) 
```

5. Print top five Boro by mean delay.

```{r}
bus.delay %>% 
  group_by(Boro) %>% 
  summarise(mean_delay = mean(duration), n_obs = n())
```

6. Look by week to see if there's any seasonality. i.e. create a plot that group by "Boro" and use facet to stratify by "Boro". 

```{r}
bus.delay %>% 
  filter(duration > 0) %>% 
  mutate(week = week(occur_date)) %>% 
  group_by(week, Boro) %>% 
  summarise(mean_delay = mean(duration)) %>% 
  ggplot(aes(week, mean_delay, color = Boro)) + 
  geom_point() + 
  geom_smooth() + 
  facet_wrap(~Boro, ncol = 4)
```


